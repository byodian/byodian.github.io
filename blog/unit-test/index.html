<!doctype html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="@byodian"><meta name="description" content="单元测试"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@byodian"><meta name="twitter:creator" content="@byodian"><meta property="og:title" content="单元测试"><meta property="og:type" content="website"><meta property="og:url" content=""><meta property="og:description" content="单元测试"><meta property="og:image" content="https://byodiandev.com/static/img/avatar-3x.png"><link rel="icon" type="image/icon" href="/static/img/favicon.ico"><link rel="stylesheet" href="/index.css"><style></style><title>单元测试</title></head><body><div id="root" class="container max-w-4xl mx-auto px-6 pt-4"><header class="mt-16 mb-8"><p><a class="font-bold" href="/">byodian's blog</a></p></header><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="text-5xl">单元测试</h1><p class="text-gray-400"><time datetime="2021年4月1日">发布于2021年4月1日</time></p></div><article class="prose lg:prose-lg"><h2>简介</h2><p>单元测试（英语：Unit Testing）又称为模块测试，是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。在过程化编程中，一个单元就是单个程序、函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类、或者派生类（子类）中的方法。</p><p>单元测试的目标是隔离程序部件并证明这些单个部件是正确的。一个单元测试提供了代码片断需要满足的严密的书面规约。</p><p>良好设计的单元测试案例覆盖程序单元分支和循环条件的所有路径。</p><h2>单元测试不应超出待测试的类边界。</h2><p>因为很多类会引用其它类，对这个类的测试经常会要求测试其它的类。一个最普遍的例子是依赖于数据库的类：为了测试它，测试人员通常编写代码去操作数据库。这是不对的，因为单元测试不应超出待测试的类边界。</p><p><strong>我们通过模拟数据库数据而非使用真正的数据库来进行后端测试。</strong></p><p>每个理想的测试案例独立于其它案例；<strong>为测试时隔离模块，经常使用stubs、mock或 fake 等测试马甲程序。</strong></p><p>如果应用逻辑简单，编写单元测试意义不大。</p><h2>定义测试环境</h2><p>Node 中的约定是用 <code>NODE_ENV</code> 环境变量定义应用的执行模式。 在我们当前的应用中，如果应用不是在生产模式下，我们只加载 <code>.env</code> 中定义的环境变量。</p><p>通常的做法是为<strong>开发和测试定义不同的模式</strong>。</p><ul><li><code>NODE_ENV=development</code></li><li><code>NODE_ENV=production</code></li><li><code>NODE_ENV=test</code></li></ul><p>通过 <code>NODE_ENV=production</code> 设置环境变量，Windows 下绝大部分 command prompts 不能正常工作，但 <strong>bash on Windows 除外。</strong></p><p>安装 <code>[cross-env](https://www.npmjs.com/package/cross-env)</code> 作为一个开发依赖包，可以解决以上问题。</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev cross-env</code></pre><h3>用法</h3><p>设置如下 npm scripts</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br><span class="token comment">// ...</span><br>	<span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>		<span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production nodemon index.js"</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2>测试库</h2><ol><li><a href="https://jestjs.io/">Jest</a> (Facebook 内部开发和使用)</li><li><a href="https://mochajs.org/">Mocha</a> (Javascript 测试库之王)</li><li><a href="https://github.com/avajs/ava">ava</a></li></ol><h2>安装</h2><pre class="language-jsx"><code class="language-jsx">npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev jest</code></pre><p>定义 npm script <code>test</code></p><p><code>&quot;test&quot;: &quot;jest —verbose&quot;</code></p><pre class="language-jsx"><code class="language-jsx"><span class="token punctuation">{</span><br>	<span class="token comment">//...</span><br>	<span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"node index.js"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"dev"</span><span class="token operator">:</span> <span class="token string">"nodemon index.js"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"build:ui"</span><span class="token operator">:</span> <span class="token string">"rm -rf build &amp;&amp; cd ../../../2/luento/notes &amp;&amp; npm run build &amp;&amp; cp -r build ../../../3/luento/notes-backend"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"deploy"</span><span class="token operator">:</span> <span class="token string">"git push heroku master"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"deploy:full"</span><span class="token operator">:</span> <span class="token string">"npm run build:ui &amp;&amp; git add . &amp;&amp; git commit -m uibuild &amp;&amp; git push &amp;&amp; npm run deploy"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"logs:prod"</span><span class="token operator">:</span> <span class="token string">"heroku logs --tail"</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"lint"</span><span class="token operator">:</span> <span class="token string">"eslint ."</span><span class="token punctuation">,</span><br>    <span class="token string-property property">"test"</span><span class="token operator">:</span> <span class="token string">"jest --verbose"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span></code></pre><p>Jest 需要指定执行环境为 Node。</p><ol><li><p>可以通过在 package.json 的末尾添加一下内容：</p><pre class="language-jsx"><code class="language-jsx"><span class="token punctuation">{</span><br>	<span class="token comment">//...</span><br>	<span class="token string-property property">"jest"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>		<span class="token string-property property">"testEnvironment"</span><span class="token operator">:</span> <span class="token string">"node"</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></li><li><p>或者，Jest 会查找默认名为 <code>jest.config.js</code> 的配置文件</p><pre class="language-jsx"><code class="language-jsx">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>	<span class="token literal-property property">testEnvironment</span><span class="token operator">:</span> <span class="token string">'node'</span><br><span class="token punctuation">}</span></code></pre></li></ol><h2>开始</h2><p>创建一个名为 tests 单独的目录，在其目录下创建名为 <code>*.test.js</code> 的测试文件。</p><p>Jest 默认情况下希望测试文件的名称包含 <code>.test.</code> 。</p><p>创建一个名为 <code>average.test.js</code> 的测试文件。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> average <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/for_testing'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>average<span class="token punctuation">;</span><br><br><span class="token comment">/* eslint-disable no-undef */</span><br><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'average'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'of one value is the value itself'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'of many is calculated right'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'of empty array is zero'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在第一行，测试文件要导入将要测试的函数。</p><p>单个测试用例是用 <code>test(string, function)</code> 函数定义的。第一个参数为字符串，是测试的描述，第二个参数为函数，其定义测试用例的功能，定义功能如下：</p><pre class="language-jsx"><code class="language-jsx"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><code>expect</code> 函数</p><p><code>toBe</code> compare primitive values or to check referential identity of object instances. It calls <a href="http://object.is/">Object.is</a> to compare values, which is even better for testing than === strict equality operator.</p><p><code>toEqual</code> compare recursively all properties of object instances (also known as &quot;deep&quot; equality). It calls <a href="http://object.is/">Object.is</a> to compare primitive values, which is even better for testing than === strict equality operator.</p><p><code>toContain</code></p><p><code>toContainEqual</code></p><p><code>toHaveLength</code></p><h2>测试数据库</h2><p>多人开发同一应用的情况下，通常要求并发运行测试，需要在开发人员本地机器上安装单独的数据库。最佳的解决方案是让每一个测试用例执行时使用自己独立的数据库，通过<a href="https://docs.mongodb.com/manual/core/inmemory/">运行内存中的 Mongo</a> 或使用 <a href="https://www.docker.com/">Docker</a> 容器来实现这个，相对简单。</p><h2>测试 API</h2><p>使用 supertest 包编写 API 的测试</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev supertest</code></pre><p>将 Express 应用提取到 app.js 文件中，并且改变了 index.js 文件的角色，使用 Node 内置的 http 对象在指定端口启动应用。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/config'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/loger'</span><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>测试端只使用 app.js 文件中定义的 express 应用：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../app'</span><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><br><br><span class="token comment">// ...</span></code></pre><p>supertest 的文档说明如下:</p><p>if the server is not already listening fot connection then it is bound to an ephmeral port for you so ther is no need to keep track of ports.</p><p>换句话说，supertest 负责在内部使用端口启动被测试的应用。</p><p>执行每个 <em>test</em> 之前使用 <code>beforeEach</code> 函数初始化数据库。</p><p>所有的 <em>test</em> 执行结束后使用 <code>afterAll</code> 函数关闭数据库连接。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/note'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> initialNotes <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'HTML is easy'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Browser can excute only JavaScript'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">true</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token comment">/* eslint-disable no-undef*/</span><br><br><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">deleteMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'REST API test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'notes are returned as json'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">await</span> api<br>      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">json</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'all notes are returned'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'a specific note is within the returned notes'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'HTML is easy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Running tests one by one</h2><p>npm test 命令执行应用的所有测试。通常明智的做法是一次只执行一个或两个测试。</p><ol><li><p><code>only</code> 方法</p><pre class="language-jsx"><code class="language-jsx">test<span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span>fn<span class="token punctuation">)</span></code></pre><p>如果测试是跨多个文件编写的，这种方法不是很友好。</p></li><li><p>使用下面的命令只运行 tests/note_api.test.js 文件中的测试</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token builtin class-name">test</span> -- tests/note_api.test.js</code></pre><p>-t 选项可用于具有特定名称的测试</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token builtin class-name">test</span> -- <span class="token parameter variable">-t</span> <span class="token string">'a specific note is within the returned notes'</span></code></pre><p><em>-t</em> 提供的参数可以引用测试或描述块的名称。参数也可以包含名称的一部分，下面的命令将运行名称中包含 <em>notes</em> 的所有测试；</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token builtin class-name">test</span> -- <span class="token parameter variable">-t</span> <span class="token string">'notes'</span></code></pre><p>注意: 当运行单个测试时，如果运行的测试没有使用该连接，则 mongoose 连接可能保持打开状态。</p><p>这个问题可能是因为 supertest 为连接优先，但是 jest 并不运行代码的 afterAll 部分。</p></li></ol><h2>提取相同测试步骤到辅助模块中</h2><p>在很多地方使用的相同的测试步骤，最好提取到辅助模块中。</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'a valid note can be added'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'async/await simplifies making async calls'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">await</span> api<br>    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">application\/json</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span><br><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><br>    <span class="token string">'async/await simplifies making async calls'</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'note without content is not added'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">true</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">await</span> api<br>    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span><br><br>  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveLength</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这两个测试都通过获取应用的所有便笺来检查保存操作之后存储在数据库中的状态。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/notes'</span><span class="token punctuation">)</span></code></pre><p>在 tests 目录下创建 test_helper.js 辅助函数，保存相同的测试步骤</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/note'</span><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> initialNotes <span class="token operator">=</span> <span class="token punctuation">[</span><br>  <span class="token punctuation">{</span><br>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'HTML is easy'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">false</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">{</span><br>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Browser can execute only Javascript'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">important</span><span class="token operator">:</span> <span class="token boolean">true</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">]</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">nonExistingId</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'willremovethissoon'</span><span class="token punctuation">,</span><span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">return</span> note<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">notesInDb</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token operator">=></span> note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  initialNotes<span class="token punctuation">,</span> nonExistingId<span class="token punctuation">,</span> notesInDb<br><span class="token punctuation">}</span></code></pre><h2>Methods</h2><ul><li>afterAll(fn, timeout)</li><li>afterEach(fn, timeout)</li><li>beforeAll(fn, timeout)</li><li>beforeEach(fn, timeout)</li><li>describe(name, fn)</li><li>describe.only(name, fn)</li><li>describe.skip(name, fn)</li><li>test(name, fn, timeout)</li><li>test.only(name, fn, timeout)</li><li>test.skip(name, fn)</li><li>test.todo(name)</li></ul><h2>logs</h2><ul><li>Your test suite must contain at least one test.</li></ul></article><footer class="mb-2"><p>byodian's blog</p></footer></div><script src="/index.js"></script><script src="https://kit.fontawesome.com/d101a7035d.js" crossorigin="anonymous"></script></body></html>