<!doctype html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="@byodian"><meta name="description" content="使用 ssh 登录远程服务器"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@byodian"><meta name="twitter:creator" content="@byodian"><meta property="og:title" content="SSH 登录远程服务器"><meta property="og:type" content="website"><meta property="og:url" content=""><meta property="og:description" content="使用 ssh 登录远程服务器"><meta property="og:image" content="https://byodiandev.com/static/img/avatar-3x.png"><link rel="icon" type="image/icon" href="/static/img/favicon.ico"><link rel="stylesheet" href="/index.css"><style></style><title>SSH 登录远程服务器</title></head><body><div id="root" class="container max-w-4xl mx-auto px-6 pt-4"><header class="mt-16 mb-8"><p><a class="font-bold" href="/">byodian's blog</a></p></header><div class="pb-5 mb-5 border-b border-gray-100"><h1 class="text-5xl">SSH 登录远程服务器</h1><p class="text-gray-400"><time datetime="2021年6月14日">发布于2021年6月14日</time></p></div><article class="prose lg:prose-lg"><h2>SSH 基础知识</h2><p>SSH （Secure Shell）是一种网络协议，用于加密两台计算机之间的通信，并且支持各种身份验证机制。</p><p>主要用于保证远程登录和远程通信的安全，任何网络服务都可以用这个协议来加密。</p><p>OpenSSH 是一个完全的 SSH 2.0 协议实现，为 OpenBSD 的开源项目。目前几乎所有的 LInux 的发行版都自带 OpenSSH。</p><p>SSH 的软件架构是服务器-客户端模式（Serve - Client）。客户端（Client）负责向服务器发出请求，OpenSSH 的实现为 <em>ssh</em>；服务器 （server）接受客户端的请求，OpenSSH 的实现为 <em>sshd</em>。</p><h3>辅助软件</h3><ul><li>ssh-keygen</li><li>ssh-agent</li><li>shh-add</li></ul><h3>客户端工具</h3><ul><li>scp</li><li>sftp</li></ul><h2>安装</h2><p>Ubuntu 操作系统下，安装 OpenSSH 客户端和服务器端应用。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># 安装客户端</span><br><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-client<br><br><span class="token comment"># 安装服务器端应用</span><br><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssh-server</code></pre><h2>更新客户端和服务器配置</h2><h3>服务器端配置</h3><p>服务器端配置文件在 <code>/etc/ssh</code> 目录，主配置文件为 <code>sshd_config</code>，此目录下还有一些安装时生成的密钥文件。</p><h3><strong>sshd 命令</strong></h3><ul><li><code>sshd -t</code> 检查配置文件的语法</li><li><code>sshd -f [filename]</code> 指定 sshd 的配置文件</li></ul><p>修改 sshd 配置文件后，并不会自动生效，必须重新启动 sshd。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># 重启</span><br><span class="token function">sudo</span> systemctl restart sshd.service<br><br><span class="token comment"># 启动</span><br><span class="token function">sudo</span> systemctl start sshd.service<br><br><span class="token comment"># 停止</span><br><span class="token function">sudo</span> systemctl stop sshd.service</code></pre><h3><strong>sshd 密钥</strong></h3><p>sshd 有自己的一对或多对密钥，它使用密钥向客户端证明自己的身份。可以通过配置文件 <code>sshd_config</code> 的 <code>HostKey</code> 配置项指定默认密钥文件。</p><p>密钥文件位于 <code>/etc/ssh</code> 目录，所有的公钥和私钥都是成对出现，公钥文件名一般是以 <code>.pub</code> 后缀结尾。</p><h3>客户端配置</h3><p>SSH 客户端的主配置文件在 <code>/etc/ssh/ssh_config</code>，用户个人配置文件在 <code>~/.ssh/config</code> ，优先级高于全局配置文件。</p><p>除了配置文件，<code>～/.ssh</code> 还有一些用户个人的密钥文件 <code>*.pub</code> 和存放 SSH 服务器的公钥指纹文件 <code>known_hosts</code>。</p><h3>用户个人的配置文件</h3><p><code>~/.ssh/config</code> 可以按照不同的服务器，列出各自的连接参数，简化 ssh 登录过程。</p><pre class="language-bash"><code class="language-bash">Host *<br>      Port <span class="token number">2222</span><br>Host remoteServer<br>      HostName <span class="token number">145.89</span>.30.234<br>      User root<br>      Port <span class="token number">2323</span></code></pre><h2>客户端 ssh</h2><h3>ssh 命令</h3><ul><li><code>ssh user@hostname</code> 登录服务器基本用法</li><li><code>ssh user@hostname -p 29393</code> 指定端口</li><li><code>ssh -l username host</code> 使用 <code>l</code> 参数，主机和用户名不需要写在一起</li></ul><h3>ssh 连接过程</h3><ol><li>验证远端服务器是否为陌生地址，第一次连接会提示不认识这台机器，提醒用户确认是否需要连接</li><li>用户点击确认后，服务器公钥指纹会被存储在 <code>~/.ssh/known_hosts</code> 文件中。每次连接服务器时，通过该文件判断是否为陌生主机。</li><li>如果服务器公钥指纹发生变更，我们也需要更新 <code>~/.ssh/known_hosts</code> 文件，将原来的公钥指纹从该文件中删除，然后使用 <code>ssh</code> 重新连接服务器将新的指纹加入 <code>known_hosts</code> 文件。</li></ol><h2>ssh 密钥登录</h2><p>SSH 默认采用密码登录，密码登录存在很多缺点。</p><ul><li>简单密码不安全</li><li>复杂密码，记忆较困难，每次都需要手动输入，比较麻烦。</li></ul><h3>密钥登录过程</h3><ol><li>将客户端的公钥加入到远程服务器的 <code>~/.ssh/authorized_keys</code> 文件。</li><li>客户端向服务器发起 SSH 登录的请求</li><li>服务器收到用户 SSH 登录的请求，发送一些随机数据给用户，要求用户证明自己的身份。</li><li>客户端收到服务器发来的数据，使用私钥对数据进行签名，然后再发送给服务器。</li><li>服务器收到客户端发来的加密签字后，使用对应的公钥解密，然后跟原始数据比较。如果一致，就允许用户登录。</li></ol><h3>生成密钥</h3><pre class="language-bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-b</span> <span class="token number">4096</span> <span class="token parameter variable">-C</span> <span class="token string">"your_email@domain.com"</span></code></pre><h3>ssh-keygen 命令配置项</h3><ul><li><code>b</code> 指定密钥的二进制位数</li><li><code>C</code> 参数可以为密钥文件指定的注释</li><li><code>f</code> 指定生成的私钥文件名称</li><li><code>F</code> 检查某个主机名是否在 <code>known_hosts</code> 文件里面</li><li><code>N</code> 指定私钥的密码</li><li><code>p</code> 重新指定私钥的密码</li><li><code>R</code> 将指定的主机公钥移除 <code>known_hosts</code> 文件</li></ul><h3>手动上传公钥</h3><p>生成的公钥必须上传到服务器，才能使用公钥登录。</p><p>OpenSSH 规定，用户公钥保存在服务器的 <code>~/.ssh/authorized_keys</code> 文件。每个公钥占据一行，<code>authorized_keys</code> 的权限应该设置为 <code>644</code></p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> ~/.ssh/id_rsa.pub <span class="token operator">|</span> <span class="token function">ssh</span> user@host <span class="token string">"mkdir -p ~/.ssh &amp;&amp; cat >> ~/.ssh/authorized_keys"</span></code></pre><pre class="language-bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">644</span> ~/.ssh/authorized_keys</code></pre><p>只要公钥上传到服务器，下次登录时，OpenSSH 就会自动采用密钥登录，不再提示输入密码。</p><h3>自动上传公钥</h3><p>OpenSSH 自带一个 <code>ssh-copy-id</code> 命令，可以自动将公钥拷贝到远程服务器的 <code>~/.ssh/authorized_keys</code> 。如果此文件不存在，<code>ssh-copy-id</code> 会自动创建该文件。</p><pre class="language-bash"><code class="language-bash">ssh-copy-id <span class="token parameter variable">-i</span> id_rsa.pub user@host</code></pre><ul><li><code>i</code> 指定公钥文件名。</li></ul><h2>ssh-agent 命令，ssh-add 命令</h2><p>私钥设置密码后，每次使用都必须输入密码，很浪费时间。比如连续使用 <code>scp</code> 命令远程拷贝文件时，每次都要求输入密码。<code>ssh-agent</code> 命令就是为了解决这个问题而设计，它让用户在整个 bash 对话（session）之中，只在第一次使用 SSH 命令时输入密码，然后将私钥保存在内存中，后续的操作都不需要输入私钥的密码。</p><h3>基本用法</h3><ol><li>新建命令行对话，<code>ssh-agent bash</code> 这里可以是任何 shell 程序，比如 zsh</li><li>在新建的 shell 对话中，使用 <code>ssh-add</code> 命令添加默认的私钥。添加私钥时，会要求输入密码，以后，在这个对话里面在使用密钥时，就不需要输入私钥的密码了，因为密钥密码已经被加入到内存中了。</li><li>使用 ssh 命令正常登录远程服务器</li><li>若要退出 ssh-agent 对话，可以直接退出 Shell （快捷键 ctrl+d），也可以使用 <code>ssh-agent -k</code> 命令。</li></ol><h3>关闭密码登录</h3><p>修改服务器 sshd 配置文件 <code>/etc/ssh/sshd_config</code> ，将<code>PasswordAuthentication</code> 这一项设置为 <code>no</code>，修改配置文件以后，需要重新启动 sshd。</p></article><footer class="mb-2"><p>byodian's blog</p></footer></div><script src="/index.js"></script><script src="https://kit.fontawesome.com/d101a7035d.js" crossorigin="anonymous"></script></body></html>